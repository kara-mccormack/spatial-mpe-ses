---
title: "nata-simulations"
author: "Kara E. McCormack"
date: "11/25/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# load libraries
library(PReMiuM)
library(stringr)
library(readr)
library(dplyr)
library(ggplot2)
library(tidyr)
```

```{r}
# set up paths
data.dir = "/Users/karamccormack/Box/SES-environment/Spatial LCM Paper/Data/"
output.dir = "/Users/karamccormack/Box/SES-environment/Spatial LCM Paper/Output/"

# load original NC NATA data
NC_df <- read_csv(file.path(data.dir, "NC_NATA_wide_total_conc.csv"))[,-1]
# load z-transformed NC NATA data
NC_df_z = read.csv(file.path(data.dir,"NC_NATA_wide_z_transform.csv"))[,-1]

colnames(NC_df_z) <- colnames(NC_df)
# need no spaces in pollutant names to plug into profile regression
colnames(NC_df_z) <- str_replace_all(colnames(NC_df_z)," " , "_")

# define covariate names
covariate_names <- colnames(NC_df_z)[-1]
```

```{r}
# Beta Plot 1
# Goal: assess convergence of variable beta 
# Specifications:
# nSweeps: 1000
# nBurn: 100
# data: z-transformed data ((value-mean)/sd)
# nClusInit = 30

# set working directory for output files
setwd("/Users/karamccormack/Box/SES-environment/Spatial LCM Paper/v2/spatial-mpe-ses/output/scratch/Beta_1/")
output.dir = "/Users/karamccormack/Box/SES-environment/Spatial LCM Paper/v2/spatial-mpe-ses/output/scratch/Beta_1/"
# run profile regression
runInfoObj_beta1 <- profRegr(yModel = "Normal",
        xModel = "Normal",
        nSweeps = 1000,
        nBurn = 100,
        data = NC_df_z,
        output = "output",
        covNames = covariate_names,
        nClusInit = 30,
        whichLabelSwitch="123",
        run = TRUE,
        excludeY = TRUE, 
        seed = 1234)

```




```{r}
# Simulation 1

# set working directory where output files will go
setwd("/Users/karamccormack/Box/SES-environment/Spatial LCM Paper/v2/spatial-mpe-ses/output/scratch/Simulation1")

# create vector of initial number of clusters
nClusInit = c(5, 7, 10, 20, 40, 50)

for (i in 1:length(nClusInit)){
  runInfoObj <- profRegr(yModel = "Normal",
        xModel = "Normal",
        nSweeps = 1000,
        nBurn = 100,
        data = NC_df_z,
        output = paste("init", nClusInit[i], sep = ""),
        covNames = covariate_names,
        nClusInit = nClusInit[i],
        whichLabelSwitch="123",
        run = TRUE,
        excludeY = TRUE, 
        seed = 1234)
  margModelPosterior(runInfoObj)
}
mmp <- list()
for(i in 1:length(nClusInit)) {
  mmp[[i]] <- read.table(paste("init", nClusInit[i], "_margModPost.txt",
                               sep = ""))[,1]
}
plot(c(head(nClusInit, n = 1) -0.5, tail(nClusInit, n = 1) + 0.5),
     c(min(unlist(mmp)), max(unlist(mmp))), type = "n",
     ylab = "Log Marginal Model Posterior",
     xlab = "Initial number of clusters", cex.lab = 1.3, xaxt = "n")
axis(1, at = nClusInit, labels = nClusInit)
for(i in 1:length(nClusInit)) {
  boxplot(mmp[[i]], add = TRUE, at = nClusInit[i], pch = ".",
          boxwex = 5, col = "coral2")
}
```



